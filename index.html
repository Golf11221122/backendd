<!DOCTYPE html>
<html lang="th">

<head>
 <meta charset="utf-8" />
 <meta name="viewport" content="width=device-width, initial-scale=1" />
 <title>POS Backoffice ‚Äî Dashboard</title>

 <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>
 <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

 <style>
  /* Minimal modern dark/grey/white theme (responsive) */
  :root {
   --bg: #0f1724;
   --card: #0b1220;
   --muted: #9aa3b2;
   --accent: #111827;
   --white: #ffffff;
   --glass: rgba(255, 255, 255, 0.03);
   --glass-2: rgba(255, 255, 255, 0.04);
   --accent-2: #111827;
   --primary: #f3f4f6;
   --success: #10b981;
  }

  html,
  body {
   height: 100%;
   margin: 0;
   font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
  }

  body {
   background: linear-gradient(180deg, #31466b 0%, #071021 60%);
   color: var(--primary);
   -webkit-font-smoothing: antialiased;
   -moz-osx-font-smoothing: grayscale;
   padding: 18px;
   box-sizing: border-box;
  }

  .app {
   max-width: 1200px;
   margin: 0 auto;
  }

  header {
   display: flex;
   gap: 12px;
   align-items: center;
   margin-bottom: 18px;
   justify-content: space-between;
  }

  .brand {
   display: flex;
   gap: 12px;
   align-items: center
  }

  .logo {
   width: 44px;
   height: 44px;
   border-radius: 8px;
   background: #fff;
   color: #111;
   display: flex;
   align-items: center;
   justify-content: center;
   font-weight: 700;
  }

  .title {
   font-size: 1.15rem;
   font-weight: 700
  }

  .subtitle {
   font-size: 0.85rem;
   color: var(--muted)
  }

  /* layout */
  .main {
   display: grid;
   grid-template-columns: 260px 1fr;
   gap: 16px;
  }

  .panel {
   background: linear-gradient(180deg, var(--card), #2252a3);
   border-radius: 12px;
   padding: 14px;
   box-shadow: 0 6px 18px rgba(0, 0, 0, 0.5);
   border: 1px solid rgba(255, 255, 255, 0.03);
  }

  /* sidebar */
  .sidebar .user {
   display: flex;
   gap: 10px;
   align-items: center;
   padding-bottom: 12px;
   border-bottom: 1px solid rgba(255, 255, 255, 0.03);
   margin-bottom: 12px;
  }

  .avatar {
   width: 44px;
   height: 44px;
   border-radius: 8px;
   background: linear-gradient(90deg, #6e6a6rgba(51, 51, 51, 0.247)333);
   display: flex;
   align-items: center;
   justify-content: center;
   font-weight: 700
  }

  .nav {
   display: flex;
   flex-direction: column;
   gap: 8px;
   margin-top: 10px
  }

  .nav button {
   background: transparent;
   border: none;
   color: var(--primary);
   padding: 10px;
   border-radius: 8px;
   text-align: left;
   cursor: pointer
  }

  .nav button.active {
   background: linear-gradient(90deg, rgba(255, 255, 255, 0.03), rgba(255, 255, 255, 0.02));
   box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.02)
  }

  .small {
   font-size: 0.85rem;
   color: var(--muted)
  }

  /* content */
  .content-grid {
   display: grid;
   grid-template-columns: repeat(2, 1fr);
   gap: 12px;
   margin-bottom: 12px;
  }

  .card {
   padding: 12px;
   border-radius: 10px;
   background: var(--glass);
   border: 1px solid rgba(255, 255, 255, 0.03)
  }

  .kpi {
   display: flex;
   justify-content: space-between;
   align-items: center;
   gap: 8px
  }

  .kpi .num {
   font-weight: 800;
   font-size: 1.4rem
  }

  .table {
   width: 100%;
   border-collapse: collapse
  }

  .table th,
  .table td {
   padding: 8px;
   border-bottom: 1px dashed rgba(255, 255, 255, 0.04);
   font-size: 0.95rem
  }

  .muted {
   color: var(--muted);
   font-size: 0.9rem
  }

  .btn {
   background: #727680;
   color: white;
   border: none;
   padding: 8px 12px;
   border-radius: 8px;
   cursor: pointer
  }

  .btn.ghost {
   background: transparent;
   border: 1px solid rgba(255, 255, 255, 0.04)
  }

  .right {
   text-align: right
  }

  .fullwidth {
   width: 100%
  }

  .search {
   padding: 8px;
   border-radius: 8px;
   border: 1px solid rgba(255, 255, 255, 0.04);
   background: transparent;
   color: var(--primary)
  }

  footer {
   margin-top: 18px;
   color: var(--muted);
   font-size: 0.85rem;
   text-align: center
  }

  /* responsive */
  @media (max-width:900px) {
   .main {
    grid-template-columns: 1fr;
   }

   .content-grid {
    grid-template-columns: 1fr;
   }
  }

  /* simple modal */
  .modal-backdrop {
   position: fixed;
   inset: 0;
   background: rgba(0, 0, 0, 0.6);
   display: none;
   align-items: center;
   justify-content: center;
   z-index: 30
  }

  .modal {
   width: 460px;
   max-width: 95%;
   background: linear-gradient(180deg, #1d4574, #0a121b);
   padding: 18px;
   border-radius: 12px;
   border: 1px solid rgba(255, 255, 255, 0.04)
  }

  .form-row {
   display: flex;
   gap: 8px;
   margin-bottom: 10px
  }

  .form-row input,
  .form-row select {
   flex: 1;
   padding: 10px;
   border-radius: 8px;
   border: 1px solid rgba(255, 255, 255, 0.04);
   background: transparent;
   color: var(--primary)
  }

  .hint {
   font-size: 0.82rem;
   color: var(--muted)
  }
 </style>
</head>

<body>
 <div class="app">
  <header>
   <div class="brand">
    <div class="logo">POS</div>
    <div>
     <div class="title">POS Backoffice</div>
     <div class="subtitle">‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏á‡∏£‡πâ‡∏≤‡∏ô ‚Äî ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏° Supabase</div>
    </div>
   </div>

   <div id="userControls">
    <button class="btn ghost" id="btnOpenAuth">Sign In / Register</button>
   </div>
  </header>

  <div class="main">
   <aside class="panel sidebar">
    <div class="user">
     <div class="avatar" id="avatar">G</div>
     <div>
      <div id="staffName" style="font-weight:700">Guest</div>
      <div class="muted" id="staffBranch">Not signed</div>
     </div>
    </div>

    <div class="nav">
     <button class="active" data-view="dashboard">Dashboard</button>
     <button data-view="sales">Sales</button>
     <button data-view="inventory">Inventory</button>
     <button data-view="reports">Reports</button>
     <button data-view="settings">Settings</button>
     <div style="height:8px"></div>
     <button id="btnSignOut" style="color:#ffdddd" class="ghost">Sign Out</button>
    </div>
   </aside>

   <main>
    <section id="view-dashboard" class="panel" style="display:block">
     <div style="display:flex;justify-content:space-between;align-items:center;gap:12px">
      <div>
       <h2 style="margin:0">Dashboard</h2>
       <div class="hint">‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏™‡∏ï‡πá‡∏≠‡∏Å ‚Äî ‡∏™‡∏≤‡∏Ç‡∏≤: <span id="currentBranchLabel">-</span></div>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
       <input id="dateFrom" class="search" type="date" /> <input id="dateTo" class="search" type="date" />
       <button class="btn" id="refreshBtn">Refresh</button>
      </div>
     </div>

     <div class="content-grid" style="margin-top:12px">
      <div class="card">
       <div class="kpi">
        <div>
         <div class="muted">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</div>
         <div class="num" id="kpiSalesToday">-</div>
        </div>
        <div class="muted">‡∏ø</div>
       </div>
       <div style="height:12px"></div>
       <div class="muted">‡∏¢‡∏≠‡∏î‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: <strong id="kpiSalesMonth">-</strong></div>
      </div>

      <div class="card">
       <div class="kpi">
        <div>
         <div class="muted">‡∏™‡∏ï‡πá‡∏≠‡∏Å‡∏Ñ‡∏á‡πÄ‡∏´‡∏•‡∏∑‡∏≠ (‡∏£‡∏ß‡∏°)</div>
         <div class="num" id="kpiStockTotal">-</div>
        </div>
        <div class="muted">‡∏ä‡∏¥‡πâ‡∏ô</div>
       </div>
       <div style="height:12px"></div>
       <div class="muted">‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏´‡∏°‡∏î: <strong id="kpiStockZero">-</strong></div>
      </div>

      <div class="card" style="grid-column:span 2">
       <h3 style="margin:0 0 8px 0">‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (7 ‡∏ß‡∏±‡∏ô)</h3>
       <canvas id="salesChart" height="100"></canvas>
      </div>

      <div class="card">
       <h4 style="margin-top:0">Top 5 ‡πÄ‡∏°‡∏ô‡∏π</h4>
       <table class="table" id="topMenuTable">
        <thead>
         <tr>
          <th>‡πÄ‡∏°‡∏ô‡∏π</th>
          <th class="right">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô</th>
         </tr>
        </thead>
        <tbody></tbody>
       </table>
      </div>

      <div class="card">
       <h4 style="margin-top:0">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h4>
       <table class="table" id="recentSalesTable">
        <thead>
         <tr>
          <th>‡πÄ‡∏ß‡∏•‡∏≤</th>
          <th>‡∏¢‡∏≠‡∏î</th>
          <th>‡∏ß‡∏¥‡∏ò‡∏µ</th>
         </tr>
        </thead>
        <tbody></tbody>
       </table>
      </div>
     </div>
    </section>

    <div class="modal-backdrop" id="authModal">
     <div class="modal">
      <h3 id="authTitle">Sign In</h3>
      <div id="authForms">
       <div id="formSignIn">
        <div class="form-row"><input id="siEmail" placeholder="Email" /></div>
        <div class="form-row"><input id="siPassword" type="password" placeholder="Password" />
        </div>
        <div style="display:flex;gap:8px">
         <button class="btn" id="btnSignInNow">Sign In</button>
         <button class="btn ghost" id="showRegister">Create account</button>
        </div>
        <div style="height:8px"></div>
        <div class="hint">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏î‡πâ‡∏ß‡∏¢‡∏ö‡∏±‡∏ç‡∏ä‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡πà‡∏≤‡∏ô‡∏´‡∏ô‡πâ‡∏≤ Register</div>
       </div>

       <div id="formRegister" style="display:none">
        <div class="form-row">
         <input id="rName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô" />
        </div>
        <div class="form-row">
         <input id="rEmail" placeholder="Email (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Login)" />
        </div>
        <div class="form-row">
         <input id="rPassword" type="password" placeholder="Password" />
         <select id="rBranch" style="min-width:120px"></select>
        </div>

        <div style="display:flex;gap:8px">
         <button class="btn" id="btnRegisterNow">Create Account</button>
         <button class="btn ghost" id="showSignIn">Back to Sign In</button>
        </div>
        <div style="height:8px"></div>
        <div class="hint">‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á Staff Code ‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ (‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: S-XXXX)
         ‡πÅ‡∏•‡∏∞‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏Å‡∏±‡∏ö‡∏™‡∏≤‡∏Ç‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</div>
       </div>
      </div>
     </div>
    </div>
   </main>
  </div>
 </div>

 <script>
  // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏Ñ‡πà‡∏≤ Supabase
   const SUPABASE_URL = 'https://pujxykbpxsncbrlquaxo.supabase.co';
   const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InB1anh5a2JweHNuY2JybHF1YXhvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI3OTI0OTIsImV4cCI6MjA3ODM2ODQ5Mn0.JxavkquEZo0W7NME4CJ01GbLKR0_gYFdcKy2BWCrAso';

   // ‡∏™‡∏£‡πâ‡∏≤‡∏á client ‡∏Ç‡∏≠‡∏á Supabase
   const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

   let currentBranchName = '-';
   let currentUserId = null;


   /**
    * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏î‡∏∂‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≤‡∏Å Branch ID ‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô User Metadata (‡∏´‡∏•‡∏±‡∏á Sign In)
    * @param {string} branchId 
    */
   async function fetchBranchName(branchId) {
    try {
     const { data, error } = await supabaseClient
      .from('branches')
      .select('name')
      .eq('id', branchId)
      .single();

     if (error) {
      console.error("Error fetching branch name:", error.message);
      return 'Unknown Branch';
     }
     return data ? data.name : 'Branch ID Not Found';

    } catch (err) {
     console.error("Error fetching branch name:", err);
     return 'Fetch Error';
    }
   }


   /**
    * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó UI ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö/‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö
    * @param {object} user - Supabase user object ‡∏´‡∏£‡∏∑‡∏≠ null
    * @param {string | null} branchName - ‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏Ç‡∏≤‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
    */
   function updateUI(user, branchName = null) {
    const staffNameElement = document.getElementById('staffName');
    const staffBranchElement = document.getElementById('staffBranch');
    const avatarElement = document.getElementById('avatar');
    const currentBranchLabel = document.getElementById('currentBranchLabel');

    if (user) {
     // ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏•‡πâ‡∏ß
     const userName = user.user_metadata?.display_name || user.email.split('@')[0];
     staffNameElement.textContent = userName;
     staffBranchElement.textContent = branchName || 'Loading branch...';
     avatarElement.textContent = userName[0].toUpperCase();
     currentBranchLabel.textContent = branchName || '-';

     document.getElementById('btnOpenAuth').style.display = 'none';
     document.getElementById('btnSignOut').style.display = 'block';
     closeAuthModal();

    } else {
     // ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
     staffNameElement.textContent = 'Guest';
     staffBranchElement.textContent = 'Not signed';
     avatarElement.textContent = 'G';
     currentBranchLabel.textContent = '-';

     document.getElementById('btnOpenAuth').style.display = 'block';
     document.getElementById('btnSignOut').style.display = 'none';
    }
   }


   /**
    * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ Top Menu 5 ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡πÅ‡∏£‡∏Å
    * @param {Array<Object>} topItems - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Top Menu
    */
   function renderTopMenuTable(topItems) {
    const tableBody = document.querySelector('#topMenuTable tbody');
    tableBody.innerHTML = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤

    if (!topItems || topItems.length === 0) {
     tableBody.innerHTML = '<tr><td colspan="2" class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡∏ô‡∏µ‡πâ</td></tr>';
     return;
    }

    topItems.forEach(item => {
     const row = tableBody.insertRow();
     row.insertCell().textContent = item.item_name;
     row.insertCell().textContent = item.count.toLocaleString('th-TH');
     row.cells[1].classList.add('right');
    });
   }

   // üö© START: 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
   /**
    * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    * @param {Array<Object>} sales - ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢
    */
   function renderRecentSalesTable(sales) {
    const tableBody = document.querySelector('#recentSalesTable tbody');
    tableBody.innerHTML = ''; // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Å‡πà‡∏≤

    if (!sales || sales.length === 0) {
     tableBody.innerHTML = '<tr><td colspan="3" class="muted">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</td></tr>';
     return;
    }

    sales.forEach(receipt => {
     // ‡∏à‡∏±‡∏î‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö‡πÄ‡∏ß‡∏•‡∏≤‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á‡πÅ‡∏Ñ‡πà HH:mm (‡πÄ‡∏ß‡∏•‡∏≤)
     const time = new Date(receipt.created_at).toLocaleTimeString('th-TH', {
      hour: '2-digit',
      minute: '2-digit'
     });

     const row = tableBody.insertRow();
     row.insertCell().textContent = time;
     row.insertCell().textContent = receipt.total_amount.toLocaleString('th-TH', {
      maximumFractionDigits: 2
     });
     row.insertCell().textContent = receipt.payment_method;
     row.cells[1].classList.add('right'); // ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå "‡∏¢‡∏≠‡∏î" ‡∏ä‡∏¥‡∏î‡∏Ç‡∏ß‡∏≤
    });
   }
   // üö© END: 1. ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏Ç‡∏≤‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î


   /**
    * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• KPI, Top Menu, ‡πÅ‡∏•‡∏∞ Inventory 
    * ‡πÇ‡∏î‡∏¢‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏°‡∏™‡∏≤‡∏Ç‡∏≤‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö
    */
   async function fetchDashboardData() {
    // üö© ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• User/Session ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡πÅ‡∏•‡∏∞ Branch ID ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
    const { data: { session } } = await supabaseClient.auth.getSession();
    const user = session?.user;
    
    if (!user) {
     console.warn("User session is missing. Cannot fetch data.");
     return;
    }

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î Branch ID ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏á (‡∏î‡∏∂‡∏á‡∏à‡∏≤‡∏Å User object ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)
    const staffBranchId = user.user_metadata?.branch_id;

    // --- ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡∏î‡∏µ‡∏ö‡∏±‡∏Å ---
    console.log("Branch ID ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Å‡∏£‡∏≠‡∏á:", staffBranchId);
    // ---------------------------------
    
    if (!staffBranchId) {
     console.error("Branch ID not found in user metadata. Cannot fetch data.");
     return;
    }

    // ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡∏∞‡∏™‡∏¥‡πâ‡∏ô‡∏™‡∏∏‡∏î
    const today = new Date().toISOString().split('T')[0];
    const firstDayOfMonth = new Date(new Date().getFullYear(), new Date().getMonth(), 1).toISOString();

    // ‡πÅ‡∏™‡∏î‡∏á‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞ Loading 
    document.getElementById('kpiSalesToday').textContent = '...';
    document.getElementById('kpiSalesMonth').textContent = '...';
    document.getElementById('kpiStockTotal').textContent = '...';
    document.getElementById('kpiStockZero').textContent = '...';
    renderTopMenuTable([]); // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á Top Menu
    renderRecentSalesTable([]); // üö© ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ï‡∏≤‡∏£‡∏≤‡∏á Recent Sales

    try {
     // --- 1. ‡∏î‡∏∂‡∏á‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ ‡πÅ‡∏•‡∏∞‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏à‡∏≤‡∏Å 'receipts' (‡πÉ‡∏ä‡πâ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö KPI & Top Menu ID) ---
     // üö© ‡πÄ‡∏û‡∏¥‡πà‡∏° payment_method ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ renderRecentSalesTable ‡∏ó‡∏≥‡∏á‡∏≤‡∏ô
     const { data: receiptsData, error: errReceipts } = await supabaseClient
      .from('receipts')
      .select('id, total_amount, created_at, payment_method')
      .eq('branch_id', staffBranchId)
      .gte('created_at', firstDayOfMonth)
      .order('created_at', { ascending: false }); // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏ä‡πâ‡πÉ‡∏ô Recent Sales

     if (errReceipts) throw errReceipts;

     let totalSalesToday = 0;
     let totalSalesMonth = 0;

     receiptsData.forEach(receipt => {
      totalSalesMonth += receipt.total_amount;
      if (receipt.created_at.startsWith(today)) {
       totalSalesToday += receipt.total_amount;
      }
     });

     document.getElementById('kpiSalesToday').textContent = totalSalesToday.toLocaleString('th-TH', { maximumFractionDigits: 2 });
     document.getElementById('kpiSalesMonth').textContent = totalSalesMonth.toLocaleString('th-TH', { maximumFractionDigits: 2 });


     // --- 2. ‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Stock (Inventory) ‡∏à‡∏≤‡∏Å 'ingredients_stock_balance' ---
     const { data: stockData, error: errInv } = await supabaseClient
      .from('ingredients_stock_balance')
      .select('balance_quantity')
      .eq('branch_id', staffBranchId);

     if (errInv) throw errInv;

     const totalStock = stockData.reduce((sum, item) => sum + item.balance_quantity, 0);
     const zeroStock = stockData.filter(item => item.balance_quantity === 0).length;

     document.getElementById('kpiStockTotal').textContent = totalStock.toLocaleString('th-TH');
     document.getElementById('kpiStockZero').textContent = zeroStock.toLocaleString('th-TH');


     // --- 3. ‡∏î‡∏∂‡∏á Top 5 Menu ‡∏à‡∏≤‡∏Å 'receipt_items' ---
     const receiptIds = receiptsData.map(r => r.id);

     if (receiptIds.length > 0) {
      const { data: itemsData, error: errItems } = await supabaseClient
       .from('receipt_items')
       .select('item_name')
       .in('receipt_id', receiptIds);

      if (errItems) throw errItems;

      const menuCounts = itemsData.reduce((acc, item) => {
       const name = item.item_name;
       acc[name] = (acc[name] || 0) + 1;
       return acc;
      }, {});

      const topMenu = Object.entries(menuCounts)
       .map(([item_name, count]) => ({ item_name, count }))
       .sort((a, b) => b.count - a.count)
       .slice(0, 5);

      renderTopMenuTable(topMenu);
     } else {
      renderTopMenuTable([]);
     }

     // üö© START: 2. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å 'receipts' (Recent Sales)
     // ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• receiptsData ‡∏ó‡∏µ‡πà‡∏î‡∏∂‡∏á‡∏°‡∏≤‡πÅ‡∏•‡πâ‡∏ß (‡∏ã‡∏∂‡πà‡∏á‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö) ‡πÅ‡∏•‡∏∞‡∏à‡∏≥‡∏Å‡∏±‡∏î‡πÅ‡∏Ñ‡πà 5 ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÅ‡∏£‡∏Å
     renderRecentSalesTable(receiptsData.slice(0, 5));
     // üö© END: 2. ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏à‡∏≤‡∏Å 'receipts' (Recent Sales)


     // üö© START: 3. ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (7 ‡∏ß‡∏±‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á) - ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö element ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏Å‡πâ TypeError
     const salesChartElement = document.getElementById('salesChart');

     if (salesChartElement) { // ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ Element ‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á
         // ** ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á (‡∏™‡∏°‡∏°‡∏ï‡∏¥) **
         // ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á‡∏Ñ‡∏ß‡∏£‡∏ñ‡∏π‡∏Å‡∏î‡∏∂‡∏á‡∏ï‡∏≤‡∏°‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà ‡πÅ‡∏ï‡πà‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÉ‡∏ä‡πâ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏°‡∏°‡∏ï‡∏¥ 7 ‡∏ß‡∏±‡∏ô
         const last7DaysData = [
             { date: '2025-11-23', total: 12000 },
             { date: '2025-11-24', total: 15500 },
             { date: '2025-11-25', total: 11000 },
             { date: '2025-11-26', total: 18000 },
             { date: '2025-11-27', total: 9500 },
             { date: '2025-11-28', total: 22000 },
             { date: '2025-11-29', total: totalSalesToday } // ‡πÉ‡∏ä‡πâ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ
         ];

         const labels = last7DaysData.map(d => new Date(d.date).toLocaleDateString('th-TH', { day: 'numeric', month: 'short' }));
         const dataValues = last7DaysData.map(d => d.total);

         // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ Chart instance ‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏¢‡∏π‡πà‡πÑ‡∏´‡∏° (‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏≤‡∏î‡∏ã‡πâ‡∏≥‡πÄ‡∏°‡∏∑‡πà‡∏≠ Refresh)
         if (window.salesChartInstance) {
             window.salesChartInstance.destroy();
         }

         const ctx = salesChartElement.getContext('2d');
         window.salesChartInstance = new Chart(ctx, {
             type: 'line',
             data: {
                 labels: labels,
                 datasets: [{
                     label: '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (‡∏ø)',
                     data: dataValues,
                     borderColor: '#10b981', // success color
                     backgroundColor: 'rgba(16, 185, 129, 0.2)',
                     tension: 0.3,
                     fill: true
                 }]
             },
             options: {
                 responsive: true,
                 maintainAspectRatio: false,
                 scales: {
                     y: {
                         beginAtZero: true,
                         grid: { color: 'rgba(255,255,255,0.1)' },
                         ticks: { color: '#f3f4f6' }
                     },
                     x: {
                         grid: { display: false },
                         ticks: { color: '#f3f4f6' }
                     }
                 },
                 plugins: {
                     legend: { display: false }
                 }
             }
         });
     } else {
         console.warn("Element 'salesChart' not found. Skipping chart rendering.");
     }
     // üö© END: 3. ‡∏ß‡∏≤‡∏î‡∏Å‡∏£‡∏≤‡∏ü‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢ (7 ‡∏ß‡∏±‡∏ô‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á)


    } catch (error) {
     console.error("Error fetching dashboard data:", error);
     // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° Error ‡πÉ‡∏ô UI ‡∏´‡∏≤‡∏Å‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ
     document.getElementById('kpiSalesToday').textContent = 'Error';
     document.getElementById('kpiSalesMonth').textContent = 'Error';
     document.getElementById('kpiStockTotal').textContent = 'Error';
     document.getElementById('kpiStockZero').textContent = 'Error';
     renderRecentSalesTable([]); // ‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏ß‡πà‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
     // ‡∏•‡∏ö alert ‡∏ó‡∏µ‡πà‡∏Å‡πà‡∏≠‡πÉ‡∏´‡πâ‡πÄ‡∏Å‡∏¥‡∏î popup ‡∏ã‡πâ‡∏≥‡πÜ
    }
   }


   /**
    * ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡πÇ‡∏´‡∏•‡∏î
    */
   async function checkUser() {
    const { data: { user } } = await supabaseClient.auth.getUser();

    if (user) {
     currentUserId = user.id;
     const branchId = user.user_metadata?.branch_id;
     let branchName = null;

     if (branchId) {
      branchName = await fetchBranchName(branchId);
      currentBranchName = branchName;
     }
     updateUI(user, branchName);

     // **‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÇ‡∏´‡∏•‡∏î Dashboard Data**
     fetchDashboardData();

    } else {
     updateUI(null);
     currentUserId = null; // üö© ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ Global ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Sign Out
     currentBranchName = '-'; // üö© ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡∏•‡πâ‡∏≤‡∏á‡∏Ñ‡πà‡∏≤ Global ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Sign Out
    }
   }

   /**
    * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≤‡∏Ç‡∏≤‡∏à‡∏≤‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á 'branches' ‡∏Ç‡∏≠‡∏á Supabase
    */
   async function loadBranches() {
    try {
     const { data, error } = await supabaseClient
      .from('branches')
      .select('id, name')
      .order('name', { ascending: true });

     if (error) {
      console.error("Error loading branches:", error.message);
      return;
     }

     const branchSelect = document.getElementById('rBranch');
     if (branchSelect) {
      branchSelect.innerHTML = '';

      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = '--- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤ ---';
      branchSelect.appendChild(defaultOption);

      if (data && data.length > 0) {
       data.forEach(branch => {
        const option = document.createElement('option');
        option.value = branch.id;
        option.textContent = branch.name;
        branchSelect.appendChild(option);
       });
      }
     }
    } catch (err) {
     console.error("Critical Error in loadBranches:", err);
    }
   }

   /**
    * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏£‡πâ‡∏≤‡∏á Staff Code (S-XXXX) ‡∏à‡∏≤‡∏Å User ID
    * @param {string} userId - UID ‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô
    */
   function generateStaffCode(userId) {
    const uniquePart = userId.substring(0, 4).toUpperCase();
    return `S-${uniquePart}`;
   }


   /**
    * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô (Create Account)
    */
   async function handleRegister() {
    const name = document.getElementById('rName').value.trim();
    const email = document.getElementById('rEmail').value.trim();
    const password = document.getElementById('rPassword').value.trim();
    const branchId = document.getElementById('rBranch').value;

    if (!name || !email || !password || !branchId) {
     alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡πÅ‡∏•‡∏∞‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏™‡∏≤‡∏Ç‡∏≤");
     return;
    }

    try {
     // --- 1. ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (Auth) ‡πÅ‡∏•‡∏∞‡πÄ‡∏Å‡πá‡∏ö user_metadata ---
     const { data, error: authError } = await supabaseClient.auth.signUp({
      email: email,
      password: password,
      options: {
       data: {
        display_name: name,
        branch_id: branchId
       }
      }
     });

     if (authError) {
      let errorMessage = authError.message;
      if (authError.message.includes('Password should be at least')) {
       errorMessage = "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 6 ‡∏ï‡∏±‡∏ß‡∏≠‡∏±‡∏Å‡∏©‡∏£";
      } else if (authError.message.includes('User already registered')) {
       errorMessage = "‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡πÉ‡∏ä‡πâ‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡πâ‡∏ß";
      }
      alert(`‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${errorMessage}`);
      return;
     }

     const newUser = data.user;
     if (!newUser) {
      alert("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ (‡πÇ‡∏õ‡∏£‡∏î‡∏•‡∏≠‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö)");
      return;
     }

     // --- 2. GENERATE STAFF ID (S-XXXX) ---
     const staffCode = generateStaffCode(newUser.id);

     // --- 3. INSERT ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô‡∏•‡∏á‡πÉ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á 'staff' ---
     const { error: staffError } = await supabaseClient
      .from('staff')
      .insert({
       staff_id: staffCode,
       user_id: newUser.id,
       name: name,
       email: email,
       branch_id: branchId
       // **‡∏ñ‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á staff ‡∏°‡∏µ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏≠‡∏∑‡πà‡∏ô ‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà**
      });

     if (staffError) {
      console.error("Staff Insert Error:", staffError.message);
      alert(`‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÅ‡∏ï‡πà‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏û‡∏ô‡∏±‡∏Å‡∏á‡∏≤‡∏ô: ${staffError.message}. ‡πÇ‡∏õ‡∏£‡∏î‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•‡∏£‡∏∞‡∏ö‡∏ö.`);
     }

     // --- 4. ‡πÅ‡∏à‡πâ‡∏á‡∏ú‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à‡πÅ‡∏•‡∏∞‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå‡∏ü‡∏≠‡∏£‡πå‡∏° ---
     alert("‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏Ñ‡∏∏‡∏ì‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß");
     document.getElementById('rName').value = '';
     document.getElementById('rEmail').value = '';
     document.getElementById('rPassword').value = '';
     document.getElementById('rBranch').value = '';
     closeAuthModal();
     showSignInForm();

    } catch (err) {
     console.error("Unexpected Register Error:", err);
     alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏á‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏≤‡∏î‡∏Ñ‡∏¥‡∏î");
    }
   }


   /**
    * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö (Sign In)
    */
   async function handleSignIn() {
    const email = document.getElementById('siEmail').value.trim();
    const password = document.getElementById('siPassword').value.trim();

    if (!email || !password) {
     alert("‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô");
     return;
    }

    try {
     const { error } = await supabaseClient.auth.signInWithPassword({
      email: email,
      password: password,
     });

     if (error) {
      alert(`‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${error.message}`);
      return;
     }

     alert("‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
     document.getElementById('siEmail').value = '';
     document.getElementById('siPassword').value = '';

     // ‡∏≠‡∏±‡∏û‡πÄ‡∏î‡∏ó UI ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ
     await checkUser();

    } catch (err) {
     console.error("Unexpected Sign In Error:", err);
     alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏Ñ‡∏≤‡∏î‡∏Ñ‡∏¥‡∏î");
    }
   }

   /**
    * ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö (Sign Out)
    */
   async function handleSignOut() {
    const { error } = await supabaseClient.auth.signOut();
    if (error) {
     console.error("Sign Out Error:", error.message);
     alert("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
     return;
    }

    alert("‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
    updateUI(null);
    currentUserId = null;
    currentBranchName = '-';
    // Clear KPIs ‡πÄ‡∏°‡∏∑‡πà‡∏≠ Sign Out
    document.getElementById('kpiSalesToday').textContent = '-';
    document.getElementById('kpiSalesMonth').textContent = '-';
    document.getElementById('kpiStockTotal').textContent = '-';
    document.getElementById('kpiStockZero').textContent = '-';
    renderTopMenuTable([]);
    renderRecentSalesTable([]);
   }

   // --- ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° Modal ‡πÅ‡∏•‡∏∞ Form ---

   function openAuthModal() {
    const modal = document.getElementById('authModal');
    if (modal) {
     modal.style.display = 'flex';
    }
   }

   function closeAuthModal() {
    const modal = document.getElementById('authModal');
    if (modal) {
     modal.style.display = 'none';
    }
   }

   function showRegisterForm() {
    document.getElementById('formSignIn').style.display = 'none';
    document.getElementById('formRegister').style.display = 'block';
    document.getElementById('authTitle').innerText = 'Create Account';
   }

   function showSignInForm() {
    document.getElementById('formSignIn').style.display = 'block';
    document.getElementById('formRegister').style.display = 'none';
    document.getElementById('authTitle').innerText = 'Sign In';
   }

   // --- Event Listeners: ‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏Ñ‡∏•‡∏¥‡∏Å ---

   document.addEventListener('DOMContentLoaded', function () {
    // 1. ‡πÇ‡∏´‡∏•‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°
    loadBranches();
    checkUser(); // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö

    // 2. Event Listeners
    const btnOpenAuth = document.getElementById('btnOpenAuth');
    const authModal = document.getElementById('authModal');
    const showRegister = document.getElementById('showRegister');
    const showSignIn = document.getElementById('showSignIn');
    const btnRegisterNow = document.getElementById('btnRegisterNow');
    const btnSignInNow = document.getElementById('btnSignInNow');
    const btnSignOut = document.getElementById('btnSignOut');


    if (btnOpenAuth) {
     btnOpenAuth.addEventListener('click', openAuthModal);
    }

    if (authModal) {
     authModal.addEventListener('click', function (e) {
      if (e.target.id === 'authModal') {
       closeAuthModal();
      }
     });
    }

    if (showRegister) {
     showRegister.addEventListener('click', showRegisterForm);
    }

    if (showSignIn) {
     showSignIn.addEventListener('click', showSignInForm);
    }

    if (btnRegisterNow) {
     btnRegisterNow.addEventListener('click', handleRegister);
    }

    if (btnSignInNow) {
     btnSignInNow.addEventListener('click', handleSignIn);
    }

    if (btnSignOut) {
     btnSignOut.addEventListener('click', handleSignOut);
    }

    // ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏° Sign Out ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    document.getElementById('btnSignOut').style.display = 'none';
   });
 </script>
</body>

</html>
